<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הוספת/עריכת iPhone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding: 0;
            color: #1d1d1f;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 22px;
        }

        /* Apple Navigation Bar */
        .nav-bar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid #d2d2d7;
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 12px 0;
        }

        .nav-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-link {
            color: #0071e3;
            text-decoration: none;
            font-size: 17px;
            font-weight: 400;
            transition: opacity 0.2s;
        }

        .back-link:hover {
            opacity: 0.7;
        }

        .nav-title {
            font-size: 17px;
            font-weight: 600;
            color: #1d1d1f;
        }

        /* Hero Section */
        header {
            background: white;
            padding: 60px 0 50px;
            text-align: center;
            border-bottom: 1px solid #d2d2d7;
        }

        header h1 {
            font-size: 48px;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        header p {
            font-size: 21px;
            color: #86868b;
            font-weight: 400;
        }

        /* Form Container */
        .form-section {
            padding: 60px 0;
        }

        .form-container {
            background: white;
            padding: 48px;
            border-radius: 18px;
            border: 1px solid #d2d2d7;
        }

        .form-group {
            margin-bottom: 28px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 8px;
            font-size: 17px;
        }

        .form-group .hint {
            display: block;
            font-size: 14px;
            color: #86868b;
            margin-top: 6px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 12px;
            font-size: 17px;
            transition: all 0.2s;
            background: #fbfbfd;
            color: #1d1d1f;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0071e3;
            background: white;
        }

        .form-group.error input,
        .form-group.error select {
            border-color: #d13032;
        }

        .error-message {
            color: #d13032;
            font-size: 14px;
            margin-top: 6px;
            display: none;
        }

        .form-group.error .error-message {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 40px;
            padding-top: 32px;
            border-top: 1px solid #d2d2d7;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 980px;
            font-size: 17px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #0071e3;
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: #0077ed;
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            color: #0071e3;
            flex: 1;
            border: 1px solid #d2d2d7;
        }

        .btn-secondary:hover {
            background: #f5f5f7;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 40px 60px;
            border-radius: 18px;
            text-align: center;
            font-size: 17px;
            font-weight: 400;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
        }

        .success-message {
            background: #d1f4e0;
            color: #0d6832;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 1px solid #a7e7c7;
        }

        .success-message.show {
            display: block;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 40px;
            }

            header p {
                font-size: 19px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-container {
                padding: 32px 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Apple Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-content">
            <a href="index.html" class="back-link">← חזרה</a>
            <div class="nav-title" id="navTitle">הוסף iPhone</div>
            <div style="width: 60px;"></div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header>
        <div class="container">
            <h1 id="pageTitle">הוסף iPhone</h1>
            <p>הזן את פרטי המכשיר</p>
        </div>
    </header>

    <!-- Form Section -->
    <div class="form-section">
        <div class="container">
            <div class="form-container">
                <div id="successMessage" class="success-message"></div>

                <form id="iphoneForm">
                    <div class="form-group">
                        <label for="model">שם הדגם</label>
                        <input type="text" id="model" name="model" placeholder="iPhone 15 Pro Max" required>
                        <span class="hint">3-30 תווים</span>
                        <span class="error-message">שדה זה הוא חובה (3-30 תווים)</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="color">צבע</label>
                            <input type="text" id="color" name="color" placeholder="Titanium Blue" required>
                            <span class="hint">3-30 תווים</span>
                            <span class="error-message">שדה זה הוא חובה</span>
                        </div>

                        <div class="form-group">
                            <label for="storageGb">נפח אחסון</label>
                            <select id="storageGb" name="storageGb" required>
                                <option value="">בחר נפח</option>
                                <option value="64">64GB</option>
                                <option value="128">128GB</option>
                                <option value="256">256GB</option>
                                <option value="512">512GB</option>
                                <option value="1024">1TB</option>
                            </select>
                            <span class="error-message">בחר נפח אחסון</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cameraCount">מספר מצלמות</label>
                            <input type="number" id="cameraCount" name="cameraCount" min="1" max="10" placeholder="3" required>
                            <span class="hint">1-10</span>
                            <span class="error-message">הזן מספר בין 1 ל-10</span>
                        </div>

                        <div class="form-group">
                            <label for="batteryMah">קיבולת סוללה</label>
                            <input type="number" id="batteryMah" name="batteryMah" min="2000" max="6000" placeholder="4500" required>
                            <span class="hint">2000-6000 mAh</span>
                            <span class="error-message">הזן מספר בין 2000 ל-6000</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="price">מחיר</label>
                        <input type="number" id="price" name="price" step="0.01" min="0" placeholder="4999" required>
                        <span class="hint">בשקלים</span>
                        <span class="error-message">הזן מחיר תקין</span>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="submitBtn">שמור</button>
                        <a href="index.html" class="btn btn-secondary">ביטול</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            שומר נתונים...
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8081/api/iphone';
        let isEditMode = false;
        let editingId = null;

        // בדיקה אם זה מצב עריכה
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            editingId = urlParams.get('id');
            
            if (editingId) {
                isEditMode = true;
                document.getElementById('pageTitle').textContent = 'ערוך iPhone';
                document.getElementById('navTitle').textContent = 'ערוך iPhone';
                loadIphoneData(editingId);
            }

            setupFormValidation();
        });

        // טעינת נתוני אייפון לעריכה
        async function loadIphoneData(id) {
            try {
                showLoading(true);
                const response = await fetch(`${API_BASE_URL}/${id}`);
                
                if (!response.ok) {
                    throw new Error('שגיאה בטעינת הנתונים');
                }
                
                const iphone = await response.json();
                
                // מילוי הטופס
                document.getElementById('model').value = iphone.model;
                document.getElementById('color').value = iphone.color;
                document.getElementById('storageGb').value = iphone.storageGb;
                document.getElementById('cameraCount').value = iphone.cameraCount;
                document.getElementById('batteryMah').value = iphone.batteryMah;
                document.getElementById('price').value = iphone.price;
                
                showLoading(false);
            } catch (error) {
                alert('שגיאה בטעינת הנתונים: ' + error.message);
                window.location.href = 'index.html';
            }
        }

        // הגדרת ולידציות
        function setupFormValidation() {
            const form = document.getElementById('iphoneForm');
            
            // ולידציה בזמן אמת
            form.querySelectorAll('input, select').forEach(field => {
                field.addEventListener('blur', () => validateField(field));
                field.addEventListener('input', () => {
                    if (field.parentElement.classList.contains('error')) {
                        validateField(field);
                    }
                });
            });

            // שליחת טופס
            form.addEventListener('submit', handleSubmit);
        }

        // ולידציה של שדה בודד
        function validateField(field) {
            const formGroup = field.parentElement;
            let isValid = true;

            // בדיקות ולידציה
            if (field.hasAttribute('required') && !field.value.trim()) {
                isValid = false;
            }

            if (field.id === 'model' || field.id === 'color') {
                if (field.value.length < 3 || field.value.length > 30) {
                    isValid = false;
                }
            }

            if (field.id === 'storageGb') {
                const value = parseInt(field.value);
                if (!value || value < 64 || value > 1024) {
                    isValid = false;
                }
            }

            if (field.id === 'cameraCount') {
                const value = parseInt(field.value);
                if (!value || value < 1 || value > 10) {
                    isValid = false;
                }
            }

            if (field.id === 'batteryMah') {
                const value = parseInt(field.value);
                if (!value || value < 2000 || value > 6000) {
                    isValid = false;
                }
            }

            if (field.id === 'price') {
                const value = parseFloat(field.value);
                if (isNaN(value) || value < 0) {
                    isValid = false;
                }
            }

            // עדכון מצב השדה
            if (isValid) {
                formGroup.classList.remove('error');
            } else {
                formGroup.classList.add('error');
            }

            return isValid;
        }

        // ולידציה של כל הטופס
        function validateForm() {
            const form = document.getElementById('iphoneForm');
            const fields = form.querySelectorAll('input, select');
            let isValid = true;

            fields.forEach(field => {
                if (!validateField(field)) {
                    isValid = false;
                }
            });

            return isValid;
        }

        // טיפול בשליחת טופס
        async function handleSubmit(e) {
            e.preventDefault();

            if (!validateForm()) {
                alert('⚠️ יש לתקן את השגיאות בטופס');
                return;
            }

            const formData = {
                model: document.getElementById('model').value.trim(),
                color: document.getElementById('color').value.trim(),
                storageGb: parseInt(document.getElementById('storageGb').value),
                cameraCount: parseInt(document.getElementById('cameraCount').value),
                batteryMah: parseInt(document.getElementById('batteryMah').value),
                price: parseFloat(document.getElementById('price').value)
            };

            try {
                showLoading(true);
                
                const url = isEditMode ? `${API_BASE_URL}/${editingId}` : API_BASE_URL;
                const method = isEditMode ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('שגיאה בשמירת הנתונים');
                }

                const savedIphone = await response.json();
                
                showLoading(false);
                showSuccess(isEditMode ? 'המכשיר עודכן בהצלחה' : 'המכשיר נוסף בהצלחה');
                
                // מעבר לדף הראשי אחרי 1.5 שניות
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);

            } catch (error) {
                showLoading(false);
                alert('שגיאה: ' + error.message);
            }
        }

        // הצגת מצב טעינה
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        // הצגת הודעת הצלחה
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('show');
        }
    </script>
</body>
</html>
